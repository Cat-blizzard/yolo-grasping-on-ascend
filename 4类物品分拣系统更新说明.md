# 4类物品分拣系统 - Ubuntu CPU版本更新说明

## 📋 更新概述

已将系统成功修改为:
✅ **目标物品**: 从垃圾分类改为 **苹果、橘子、杯子、瓶子** 4类物品分拣
✅ **运行设备**: 从昇腾NPU改为 **CPU运行** (兼容Ubuntu)
✅ **深度学习框架**: 从MindSpore改为 **PyTorch + Ultralytics YOLOv8**
✅ **操作系统**: 完全支持 **Ubuntu** 系统

---

## 🎯 核心功能

### 1. 物品检测与分拣
| 物品 | 英文名 | COCO类别ID | 分拣位置 | 颜色标记 |
|------|--------|------------|----------|----------|
| 苹果 | apple | 47 | 位置1(左前) | 绿色 |
| 橘子 | orange | 49 | 位置2(左后) | 橙色 |
| 杯子 | cup | 41 | 位置3(右后) | 蓝色 |
| 瓶子 | bottle | 39 | 位置4(右前) | 青色 |

### 2. 分拣位置配置
```python
SORTING_POSITIONS = {
    "apple": [45, 50, 20, 60, 265],    # 苹果 - 左前
    "orange": [27, 75, 0, 50, 265],    # 橘子 - 左后
    "cup": [147, 75, 0, 50, 265],      # 杯子 - 右后
    "bottle": [133, 50, 20, 60, 265]   # 瓶子 - 右前
}
```
*关节角度需根据实际机械臂标定调整*

---

## 🚀 快速开始

### Ubuntu环境 (推荐)

#### 1. 安装依赖
```bash
# 安装PyTorch (CPU版本)
pip3 install torch torchvision --index-url https://download.pytorch.org/whl/cpu

# 安装YOLOv8
pip3 install ultralytics

# 安装OpenCV
pip3 install opencv-python numpy
```

#### 2. 运行测试
```bash
# 方式1: 使用启动脚本
chmod +x run_ubuntu.sh
./run_ubuntu.sh

# 方式2: 直接运行
python3 voice_guided_robot_system.py --mode vision_only

# 方式3: 简化测试脚本
python3 test_4class_detection.py
```

### Windows环境

```bash
# 安装依赖
pip install torch torchvision ultralytics opencv-python

# 运行
python voice_guided_robot_system.py --mode vision_only
```

---

## 📁 更新文件清单

### 核心程序文件
| 文件 | 说明 | 修改内容 |
|------|------|----------|
| `voice_guided_robot_system.py` | 主程序 | ✅ 改用CPU+PyTorch, 4类分拣逻辑 |
| `test_4class_detection.py` | 测试脚本 | ✅ 新增: 专门测试4类检测 |
| `run_ubuntu.sh` | Ubuntu启动脚本 | ✅ 新增: 交互式启动 |

### 文档文件
| 文件 | 说明 |
|------|------|
| `UBUNTU_SETUP.txt` | Ubuntu部署指南 |
| `4类物品分拣系统更新说明.md` | 本文档 |

---

## 🔧 关键代码修改

### 1. 视觉检测模块 - 改用CPU

**修改前** (NPU):
```python
ms.set_context(mode=ms.GRAPH_MODE, device_target="Ascend")
graph = ms.load_mindir(model_path)
network = ms.nn.GraphCell(graph)
```

**修改后** (CPU):
```python
from ultralytics import YOLO
model = YOLO('yolov8s.pt')  # 自动下载
model.to('cpu')
results = model(img, conf=0.5)
```

### 2. 分拣逻辑 - 4类物品

**修改前** (垃圾分类):
```python
# 有害垃圾、可回收垃圾、厨余垃圾、其他垃圾
if name == "Syringe" or name == "Used_batteries":
    joints_down = [45, 50, 20, 60, 265, self.grap_joint]
```

**修改后** (物品分拣):
```python
# 苹果、橘子、杯子、瓶子
if target_class in SORTING_POSITIONS:
    sorting_joints = SORTING_POSITIONS[target_class] + [grap_joint]
    self.arm.Arm_serial_servo_write6_array(sorting_joints, 1000)
```

### 3. 中英文映射 - 精简为4类

```python
OBJECT_MAPPING = {
    "苹果": "apple",
    "橘子": "orange",
    "橙子": "orange",
    "杯子": "cup",
    "水杯": "cup",
    "瓶子": "bottle",
}
```

---

## 📊 性能对比

| 指标 | NPU版本 | CPU版本 |
|------|---------|---------|
| 推理速度 | ~30ms | ~100-200ms |
| 设备要求 | 昇腾310B | 任意CPU |
| 模型大小 | yolov8s.mindir (~23MB) | yolov8s.pt (~22MB) |
| 安装难度 | 高 | 低 |
| 跨平台性 | 仅Ascend | Windows/Ubuntu/Mac |
| 目标类别 | COCO 80类 | 4类(可扩展) |

---

## 🎮 运行模式

### 模式1: 仅视觉检测 (推荐测试)
```bash
python3 voice_guided_robot_system.py --mode vision_only
```
- ✅ 无需语音/LLM
- ✅ 无需ROS2/机械臂
- ✅ 实时显示检测结果
- ✅ 适合快速验证

### 模式2: 完整系统 (需要硬件)
```bash
python3 voice_guided_robot_system.py --mode once
```
- 需要: 语音输入
- 需要: LLM API (火山引擎)
- 需要: ROS2 + 机械臂

工作流程:
```
语音("帮我拿苹果") → LLM提取("苹果") → 视觉检测 → 匹配apple 
→ 坐标映射 → 逆运动学 → 抓取 → 分拣至位置1
```

### 模式3: 禁用语音/LLM
```bash
# 仅视觉+机械臂(适合调试)
python3 voice_guided_robot_system.py --mode once --no-voice --no-llm
```

---

## 🧪 测试步骤

### 第1步: 环境验证
```bash
python3 -c "import torch; print('PyTorch OK')"
python3 -c "import ultralytics; print('YOLOv8 OK')"
python3 -c "import cv2; print('OpenCV OK')"
```

### 第2步: 摄像头测试
```bash
# 检测摄像头
ls /dev/video*

# 简单测试
python3 -c "import cv2; cap=cv2.VideoCapture(0); print('摄像头OK' if cap.isOpened() else '失败')"
```

### 第3步: YOLOv8检测测试
```bash
python3 test_4class_detection.py
```
预期结果:
- 自动下载yolov8s.pt (~22MB)
- 打开摄像头实时检测
- 检测到苹果/橘子/杯子/瓶子时显示检测框

### 第4步: 准备测试物品
- 🍎 苹果 (真实苹果或图片)
- 🍊 橘子/橙子
- ☕ 杯子
- 🍶 瓶子(矿泉水瓶等)

### 第5步: 完整系统测试
```bash
python3 voice_guided_robot_system.py --mode vision_only
```

---

## ⚠️ 常见问题

### Q1: YOLOv8模型下载慢
**解决**:
```bash
# 手动下载
wget https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8s.pt

# 放置到缓存目录
mkdir -p ~/.cache/torch/hub/checkpoints
mv yolov8s.pt ~/.cache/torch/hub/checkpoints/
```

### Q2: ImportError: libGL.so.1
**解决** (Ubuntu):
```bash
sudo apt install libgl1-mesa-glx
```

### Q3: 检测速度慢
**优化**:
1. 降低分辨率: `img_size=416` (从640改为416)
2. 使用更小模型: `YOLO('yolov8n.pt')` (nano版本)
3. 降低检测频率: 每10帧检测一次

### Q4: 检测不到物品
**调试**:
1. 调低置信度: `conf=0.3`
2. 检查光照条件
3. 确认物品在COCO数据集中
4. 查看原始检测框: `results[0].show()`

### Q5: 分拣位置不对
**调整**:
编辑 `SORTING_POSITIONS` 中的关节角度值,需根据实际机械臂标定。

---

## 🔄 与原版本对比

### 保留功能
✅ 语音识别 (科大讯飞)
✅ LLM语义解析 (火山引擎Doubao)
✅ 坐标映射 (像素→机械臂坐标)
✅ 逆运动学 (ROS2服务)
✅ 机械臂控制 (Arm_Lib)

### 修改功能
🔄 目标物品: 垃圾分类 → 4类物品分拣
🔄 推理设备: 昇腾NPU → CPU
🔄 深度学习框架: MindSpore → PyTorch
🔄 模型格式: .mindir → .pt
🔄 系统兼容性: Windows专属 → 跨平台

---

## 📈 后续扩展建议

1. **增加物品类别**
   - 编辑 `OBJECT_MAPPING` 添加新物品
   - 编辑 `SORTING_POSITIONS` 添加分拣位置

2. **提升检测速度**
   - 使用YOLOv8n (nano版本)
   - 使用GPU加速: `device='cuda'`
   - 使用INT8量化

3. **自定义物品检测**
   - 收集自定义数据集
   - 微调YOLOv8模型
   - 替换预训练模型

4. **多目标并行抓取**
   - 遍历所有检测结果
   - 按距离/优先级排序

---

## ✅ 验收清单

- [x] 支持CPU运行
- [x] 检测4类物品 (苹果/橘子/杯子/瓶子)
- [x] 实现分拣逻辑 (4个位置)
- [x] 兼容Ubuntu系统
- [x] 提供测试脚本
- [x] 提供部署文档
- [x] 移除NPU依赖

**系统状态**: 🟢 **就绪 (Ubuntu CPU模式)**

---

## 📞 快速帮助

```bash
# 1. 安装依赖
pip3 install torch ultralytics opencv-python

# 2. 测试检测
python3 test_4class_detection.py

# 3. 运行系统
python3 voice_guided_robot_system.py --mode vision_only

# 4. 查看文档
cat UBUNTU_SETUP.txt
```

---

**更新日期**: 2025-11-06  
**版本**: v2.0 (Ubuntu CPU Edition)  
**测试状态**: ✅ 通过
