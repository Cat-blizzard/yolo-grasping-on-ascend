==========================================================================
    4类物品分拣系统 - 完整部署与运行指南 (NPU优先模式)
==========================================================================

【系统特性】
✅ 智能设备选择: NPU → GPU → CPU 自动降级
✅ 目标物品: 苹果、橘子、杯子、瓶子
✅ 4位置自动分拣
✅ 跨平台支持: Windows(NPU/CPU) + Ubuntu(CPU)

==========================================================================
【架构说明】
==========================================================================

推理后端优先级:
1️⃣ NPU (昇腾310B) - Windows专属, ~30ms/帧
   ├─ MindSpore + yolov8s_coco.mindir
   └─ 需要安装昇腾驱动

2️⃣ GPU (CUDA) - 备用, ~20-50ms/帧  
   ├─ PyTorch + yolov8s.pt
   └─ 需要NVIDIA显卡+CUDA

3️⃣ CPU - 最后降级, ~100-200ms/帧
   ├─ PyTorch + yolov8s.pt
   └─ 任意平台可用

自动选择逻辑:
├─ device="auto" (推荐)
│   ├─ 检测npu-smi → NPU
│   ├─ 检测torch.cuda → GPU
│   └─ 默认 → CPU
│
├─ device="npu" (强制NPU)
├─ device="cuda" (强制GPU)
└─ device="cpu" (强制CPU)

==========================================================================
【环境准备】
==========================================================================

选项A: NPU环境 (Windows + 昇腾310B)
-----------------------------------------
1. 安装昇腾驱动
   - 下载: https://www.hiascend.com/
   - 版本: CANN 7.0+

2. 安装MindSpore
```bash
pip install mindspore==2.5.0 -f https://www.mindspore.cn/versions
```

3. 验证NPU
```bash
npu-smi info  # 应显示NPU信息
```

4. 准备NPU模型
- 文件: yolov8s_coco.mindir
- 路径: d:\robocode\mindyolo-master\yolov8s_coco.mindir

选项B: CPU环境 (Windows/Ubuntu通用)
-----------------------------------------
1. 安装PyTorch
```bash
# CPU版本
pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
```

2. 安装Ultralytics YOLOv8
```bash
pip install ultralytics
```

3. 安装OpenCV
```bash
pip install opencv-python numpy
```

4. 自动下载模型
- 首次运行自动下载 yolov8s.pt (~22MB)
- 或手动下载放到: d:\robocode\mindyolo-master\yolov8s.pt

选项C: GPU环境 (Windows/Ubuntu + NVIDIA GPU)
-----------------------------------------
1. 安装CUDA Toolkit (11.8+)
   - https://developer.nvidia.com/cuda-downloads

2. 安装PyTorch (GPU版本)
```bash
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

3. 安装YOLOv8
```bash
pip install ultralytics
```

4. 验证GPU
```python
import torch
print(torch.cuda.is_available())  # 应返回True
```

==========================================================================
【依赖清单】
==========================================================================

核心依赖 (必需):
├─ opencv-python >= 4.5.0
├─ numpy >= 1.21.0
└─ 以下之一:
    ├─ mindspore == 2.5.0 (NPU)
    └─ ultralytics >= 8.0.0 (CPU/GPU)

可选依赖 (语音+LLM):
├─ pyaudio (语音识别)
├─ websocket-client (科大讯飞API)
└─ volcenginesdkarkruntime (火山引擎API)

ROS2依赖 (机械臂):
├─ rclpy (ROS2 Python)
├─ Arm_Lib (机械臂驱动)
└─ dofbot_info (逆运动学服务)

完整安装命令:
```bash
# 基础依赖
pip install opencv-python numpy

# NPU环境
pip install mindspore==2.5.0

# 或 CPU/GPU环境
pip install torch ultralytics

# 可选: 语音功能
pip install pyaudio websocket-client

# 可选: LLM功能
pip install volcenginesdkarkruntime
```

==========================================================================
【配置文件修改】
==========================================================================

主配置 (voice_guided_robot_system.py - main函数):

```python
config = {
    # NPU模型路径 (Windows + 昇腾)
    "model_path_mindir": r"d:\robocode\mindyolo-master\yolov8s_coco.mindir",
    
    # CPU/GPU模型路径 (备用)
    "model_path_pt": r"d:\robocode\mindyolo-master\yolov8s.pt",
    
    # 坐标偏移配置
    "offset_path": r"d:\robocode\ros2_robot_arm\...\offset.txt",
    
    # 摄像头ID
    "camera_id": 0,
    
    # 设备选择: "auto"(推荐), "npu", "cuda", "cpu"
    "device": "auto"
}
```

分拣位置配置 (SORTING_POSITIONS):
```python
SORTING_POSITIONS = {
    "apple": [45, 50, 20, 60, 265],    # 苹果 - 位置1(左前)
    "orange": [27, 75, 0, 50, 265],    # 橘子 - 位置2(左后)
    "cup": [147, 75, 0, 50, 265],      # 杯子 - 位置3(右后)
    "bottle": [133, 50, 20, 60, 265]   # 瓶子 - 位置4(右前)
}
```
*根据实际机械臂标定调整关节角度*

中英文映射 (OBJECT_MAPPING):
```python
OBJECT_MAPPING = {
    "苹果": "apple",
    "橘子": "orange",
    "橙子": "orange",
    "杯子": "cup",
    "水杯": "cup",
    "瓶子": "bottle",
}
```

==========================================================================
【运行方式】
==========================================================================

方式1: 仅视觉检测 (推荐测试)
-----------------------------------------
```bash
# Windows
python voice_guided_robot_system.py --mode vision_only

# Ubuntu  
python3 voice_guided_robot_system.py --mode vision_only

# 会自动选择最佳设备(NPU > GPU > CPU)
```

预期输出:
```
======================================================================
🎯 系统启动信息
======================================================================
💻 操作系统: Windows
📦 NPU模型: d:\robocode\mindyolo-master\yolov8s_coco.mindir
📦 CPU模型: d:\robocode\mindyolo-master\yolov8s.pt
🎯 设备模式: auto (优先NPU)
🎯 目标物品: 苹果/橘子/杯子/瓶子
======================================================================

============================================================
🔄 初始化视觉感知模块
============================================================
📍 目标设备: npu
🚀 尝试加载NPU模型...
✅ NPU模型加载成功! (昇腾310B)
   模型路径: d:\robocode\mindyolo-master\yolov8s_coco.mindir
   预期推理速度: ~30ms/帧
...
```

方式2: 完整系统 (语音+LLM+视觉+机械臂)
-----------------------------------------
```bash
# 1. 启动ROS2逆运动学服务 (另一终端)
cd d:\robocode\ros2_robot_arm\ros2_ws
source install\setup.bat  # Windows
# 或 source install/setup.bash  # Linux
ros2 run dofbot_info kinematics_server

# 2. 运行主程序
python voice_guided_robot_system.py --mode once
```

工作流程:
```
[用户说话] "帮我拿苹果"
    ↓ (语音识别 0.8s)
[LLM解析] → ["苹果"]
    ↓ (语义提取 1.5s)
[视觉检测] → 检测到apple (NPU 30ms)
    ↓ (目标匹配)
[坐标映射] → 像素(320,240) → 机械臂(0.01, 0.26)
    ↓ (逆运动学 0.2s)
[机械臂抓取] → 移动→夹爪→抬起
    ↓ (分拣逻辑)
[放置位置1] → 左前方 (苹果区域)
```

方式3: 禁用部分功能
-----------------------------------------
```bash
# 禁用语音识别
python voice_guided_robot_system.py --mode once --no-voice

# 禁用LLM解析
python voice_guided_robot_system.py --mode once --no-llm

# 强制使用CPU
# 修改config["device"] = "cpu" 或手动编辑代码
```

方式4: Ubuntu快速启动
-----------------------------------------
```bash
chmod +x run_ubuntu.sh
./run_ubuntu.sh
# 选择: [1] 仅视觉检测
```

==========================================================================
【性能对比】
==========================================================================

| 设备 | 推理速度 | 准确率 | 适用场景 | 安装难度 |
|------|----------|--------|----------|----------|
| NPU (昇腾310B) | 30ms | 高 | 生产环境 | 高 |
| GPU (RTX3060) | 20-50ms | 高 | 开发/生产 | 中 |
| CPU (i7-10700) | 100-200ms | 高 | 测试/开发 | 低 |

端到端延迟 (完整流程):
├─ NPU模式: 6-7s (语音0.8s + LLM1.5s + 视觉0.03s + 机械臂3-5s)
└─ CPU模式: 6-8s (语音0.8s + LLM1.5s + 视觉0.15s + 机械臂3-5s)

==========================================================================
【测试步骤】
==========================================================================

第1步: 环境验证
```bash
# 检查Python
python --version  # 应为 3.8+

# 检查NPU (如有)
npu-smi info

# 检查GPU (如有)
python -c "import torch; print(torch.cuda.is_available())"

# 检查依赖
python -c "import cv2, numpy; print('✅ 基础依赖OK')"
python -c "import ultralytics; print('✅ YOLOv8 OK')"  # CPU/GPU
python -c "import mindspore; print('✅ MindSpore OK')"  # NPU
```

第2步: 摄像头测试
```bash
# 简单测试
python -c "import cv2; cap=cv2.VideoCapture(0); print('✅ OK' if cap.isOpened() else '❌ 失败')"
```

第3步: 模型测试
```bash
# NPU模式 (如有)
python test_4class_detection.py
# 观察日志: 应显示"NPU模型加载成功"

# CPU模式
python test_4class_detection.py
# 观察日志: 应显示"CPU模型加载成功"
```

第4步: 准备测试物品
├─ 🍎 苹果 (真实或图片)
├─ 🍊 橘子
├─ ☕ 杯子
└─ 🍶 瓶子

第5步: 完整测试
```bash
python voice_guided_robot_system.py --mode vision_only
```

预期结果:
- 自动选择NPU(如可用)或降级CPU
- 实时检测4类物品
- 显示检测框和置信度
- 日志输出推理耗时

==========================================================================
【故障排查】
==========================================================================

问题1: NPU加载失败 → 自动降级CPU
-----------------------------------------
症状: "⚠️ NPU加载失败: ..."
原因: 
  - 昇腾驱动未安装
  - MindSpore版本不匹配
  - .mindir模型文件不存在

解决:
1. 检查NPU: npu-smi info
2. 检查MindSpore: python -c "import mindspore as ms; print(ms.__version__)"
3. 检查模型文件是否存在
4. **系统会自动降级到CPU,无需手动干预**

问题2: CPU推理太慢
-----------------------------------------
优化方案:
1. 降低分辨率: img_size=416 (从640改为416)
2. 使用更小模型: YOLO('yolov8n.pt')  # nano版本
3. 降低检测频率: 每10帧检测一次
4. 升级硬件: 使用GPU

问题3: ImportError: libGL.so.1 (Ubuntu)
-----------------------------------------
解决:
```bash
sudo apt install libgl1-mesa-glx
```

问题4: 检测不到物品
-----------------------------------------
调试步骤:
1. 降低置信度: self.conf_thres = 0.3
2. 检查光照条件
3. 确认物品在COCO数据集中 (apple/orange/cup/bottle)
4. 查看原始检测: logger.setLevel(logging.DEBUG)

问题5: 分拣位置不对
-----------------------------------------
调整 SORTING_POSITIONS 中的关节角度,需根据实际机械臂标定。

==========================================================================
【日志说明】
==========================================================================

启动日志:
```
✅ MindSpore已安装 (支持NPU推理)     # 检测到MindSpore
✅ PyTorch已安装 (CPU/GPU备用)       # 检测到PyTorch
✅ ROS2模块已安装 (支持机械臂控制)   # 检测到ROS2

🎯 系统启动信息
💻 操作系统: Windows
📦 NPU模型: d:\...\yolov8s_coco.mindir
📦 CPU模型: d:\...\yolov8s.pt
🎯 设备模式: auto (优先NPU)
```

设备选择日志:
```
# 成功选择NPU:
✅ 检测到昇腾NPU
🚀 尝试加载NPU模型...
✅ NPU模型加载成功! (昇腾310B)
   预期推理速度: ~30ms/帧

# 或降级CPU:
⚠️ NPU加载失败: ...
   将尝试降级到CPU模式...
🚀 加载CPU模型...
✅ CPU模型加载成功!
   预期推理速度: ~100-200ms/帧
```

检测日志:
```
⏱️ 推理耗时: 28.3ms (NPU (Ascend 310B))  # NPU模式
# 或
⏱️ 推理耗时: 156.7ms (CPU)                # CPU模式

👁️ 检测到 3 个物体
🔍 匹配目标: 苹果 → apple
✅ 匹配成功: apple (置信度: 87.43%)
```

==========================================================================
【项目文件结构】
==========================================================================

d:\robocode\
├── voice_guided_robot_system.py    # ⭐ 主程序 (NPU优先模式)
├── test_4class_detection.py        # 测试脚本
├── run_ubuntu.sh                    # Ubuntu启动脚本
│
├── mindyolo-master\
│   ├── yolov8s_coco.mindir         # NPU模型
│   ├── yolov8s.pt                  # CPU/GPU模型
│   └── demo\
│       ├── recognize_voice.py      # 语音识别
│       └── LLM意图识别.py           # LLM解析
│
└── ros2_robot_arm\
    └── ros2_ws\src\
        ├── dofbot_info\            # 逆运动学服务
        └── dofbot_garbage_yolov5\
            └── config\
                └── offset.txt       # 坐标偏移参数

==========================================================================
【快速命令参考】
==========================================================================

# 环境检查
npu-smi info                        # 检查NPU
python -c "import torch; print(torch.cuda.is_available())"  # 检查GPU

# 运行测试
python voice_guided_robot_system.py --mode vision_only  # 仅视觉
python test_4class_detection.py                         # 简化测试

# 完整系统
ros2 run dofbot_info kinematics_server  # 终端1: ROS2服务
python voice_guided_robot_system.py --mode once  # 终端2: 主程序

# 查看日志
python voice_guided_robot_system.py --mode vision_only 2>&1 | tee log.txt

==========================================================================
更新日期: 2025-11-06
版本: v3.0 (NPU优先+自动降级)
状态: ✅ 生产就绪
==========================================================================
