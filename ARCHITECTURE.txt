================================================================================
           视觉引导机械臂抓取系统 - 架构设计文档
================================================================================

【系统分层架构】

┌─────────────────────────────────────────────────────────────────────┐
│                        交互层 (Interaction Layer)                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  [老年人语音指令] ──► [USB麦克风采集(16kHz)] ──► [PyAudio]           │
│                               │                                      │
│                               ▼                                      │
│                    [科大讯飞 IAT WebSocket API]                      │
│                               │                                      │
│                               ▼                                      │
│                      "帮我拿水杯" (文本输出)                         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        决策层 (Decision Layer)                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  模块1: LLM语义解析                                                   │
│  ┌──────────────────────────────────────────────┐                   │
│  │ 输入: "帮我拿水杯"                            │                   │
│  │ 模型: 火山引擎 Doubao-1.5-pro-32k             │                   │
│  │ Prompt: "提取物品名称,格式:[物品1, 物品2]"    │                   │
│  │ 输出: ["水杯"]                               │                   │
│  └──────────────────────────────────────────────┘                   │
│                               │                                      │
│                               ▼                                      │
│  模块2: 目标匹配引擎                                                  │
│  ┌──────────────────────────────────────────────┐                   │
│  │ 中英文映射: {"水杯": "cup", ...}             │                   │
│  │ 输入: voice_target="水杯"                    │                   │
│  │       visual_detections=[{class_name: "cup"}]│                   │
│  │ 逻辑: 语义匹配 + 置信度筛选                   │                   │
│  │ 输出: 最佳目标实例(置信度最高)                │                   │
│  └──────────────────────────────────────────────┘                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        感知层 (Perception Layer)                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  模块1: 图像采集                                                      │
│  ┌──────────────────────────────────────────────┐                   │
│  │ USB摄像头: 1280×720, MJPG格式                │                   │
│  │ OpenCV VideoCapture(0)                       │                   │
│  │ 预处理: resize → 640×480                     │                   │
│  └──────────────────────────────────────────────┘                   │
│                               │                                      │
│                               ▼                                      │
│  模块2: YOLOv8s 目标检测                                              │
│  ┌──────────────────────────────────────────────┐                   │
│  │ 框架: MindYOLO + MindSpore 2.5               │                   │
│  │ 模型: yolov8s_coco.mindir (MindIR格式)       │                   │
│  │ 设备: 昇腾310B NPU (Graph模式)               │                   │
│  │ 推理流程:                                     │                   │
│  │   1. 图像预处理: BGR→RGB, Resize→640×640     │                   │
│  │   2. Tensor化: NCHW, [0,1]归一化             │                   │
│  │   3. NPU推理: network(img_tensor) (~30ms)    │                   │
│  │   4. NMS后处理: conf_thres=0.5, iou=0.65     │                   │
│  │   5. 坐标映射: 网络输出→原图坐标              │                   │
│  │ 输出:                                         │                   │
│  │   - class_name: "cup"                        │                   │
│  │   - confidence: 0.87                         │                   │
│  │   - bbox: [x1, y1, x2, y2]                   │                   │
│  │   - center: (cx, cy) 像素坐标                │                   │
│  └──────────────────────────────────────────────┘                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        执行层 (Execution Layer)                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  模块1: 坐标映射                                                      │
│  ┌──────────────────────────────────────────────┐                   │
│  │ 输入: 像素坐标 (u, v)                         │                   │
│  │ 映射公式:                                     │                   │
│  │   a = ((pixel_x - 320) / 4000)               │                   │
│  │   b = ((480 - pixel_y) / 3000) * 0.8 + 0.19  │                   │
│  │ 偏移补偿 (offset.txt):                        │                   │
│  │   x = a + x_offset (0.01)                    │                   │
│  │   y = b + y_offset (0.016)                   │                   │
│  │ 输出: 机械臂基坐标 (x, y, z)                  │                   │
│  └──────────────────────────────────────────────┘                   │
│                               │                                      │
│                               ▼                                      │
│  模块2: 逆运动学解算 (ROS2服务)                                       │
│  ┌──────────────────────────────────────────────┐                   │
│  │ 服务: dofbot_info/Kinemarics.srv             │                   │
│  │ 输入: tar_x, tar_y, tar_z, kin_name="ik"     │                   │
│  │ 算法: 数值迭代法 (基于Orocos KDL)            │                   │
│  │ 输出: [joint1, joint2, ..., joint6]          │                   │
│  │ 角度调整:                                     │                   │
│  │   if joints[2] < 0:                          │                   │
│  │     joints[1] += joints[2] / 2               │                   │
│  │     joints[3] += joints[2] * 3 / 4           │                   │
│  │     joints[2] = 0                            │                   │
│  └──────────────────────────────────────────────┘                   │
│                               │                                      │
│                               ▼                                      │
│  模块3: 机械臂运动控制                                                │
│  ┌──────────────────────────────────────────────┐                   │
│  │ 驱动库: Arm_Lib.Arm_Device()                 │                   │
│  │ 通信: UART 串口 115200bps (40PIN排线)         │                   │
│  │ 动作序列:                                     │                   │
│  │   1. 蜂鸣器提示 (Arm_Buzzer_On)              │                   │
│  │   2. 移动到目标上方 (joints_up)              │                   │
│  │   3. 松开夹爪 (Servo_write(6, 0))            │                   │
│  │   4. 下降至目标 (joints_target)              │                   │
│  │   5. 闭合夹爪 (Servo_write(6, 130))          │                   │
│  │   6. 抬起 (joints_up)                        │                   │
│  │   7. 返回初始位置 (joints_init)              │                   │
│  │   8. 释放物体 (Servo_write(6, 30))           │                   │
│  │ 安全保护:                                     │                   │
│  │   - 夹爪过载保护 (力传感器)                   │                   │
│  │   - MoveIt碰撞检测 (AABB算法)                │                   │
│  └──────────────────────────────────────────────┘                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘


================================================================================
【关键技术细节】
================================================================================

1. 语音识别技术栈
   ┌──────────────────────────────────────┐
   │ PyAudio (音频采集)                    │
   │   ├─ 采样率: 16000 Hz                │
   │   ├─ 声道: 单声道                     │
   │   ├─ 格式: paInt16                    │
   │   └─ 帧大小: 8000 samples             │
   ├──────────────────────────────────────┤
   │ WebSocket (流式传输)                  │
   │   ├─ 协议: WSS (加密)                 │
   │   ├─ 认证: HMAC-SHA256                │
   │   ├─ Base64编码音频流                 │
   │   └─ 增量结果回调                     │
   ├──────────────────────────────────────┤
   │ 科大讯飞 IAT API                      │
   │   ├─ 引擎: iat (实时转写)             │
   │   ├─ 语言: zh_cn (简体中文)           │
   │   ├─ 口音: mandarin (普通话)          │
   │   └─ VAD: 10000ms (静音检测)          │
   └──────────────────────────────────────┘

2. LLM调用流程
   ┌──────────────────────────────────────┐
   │ 火山引擎 Ark SDK                      │
   │   ├─ API Key: 9b55f097-562a-...      │
   │   ├─ 模型: doubao-1.5-pro-32k        │
   │   └─ 上下文长度: 32K tokens           │
   ├──────────────────────────────────────┤
   │ System Prompt 设计                    │
   │   ├─ 角色定位: 助老命令判断助手       │
   │   ├─ 任务描述: 提取物品名称           │
   │   ├─ 输出格式: [物品1, 物品2, ...]    │
   │   └─ 异常处理: 无法提取返回 []        │
   ├──────────────────────────────────────┤
   │ 响应解析                              │
   │   ├─ 去除空格和中文逗号               │
   │   ├─ 解析列表格式                     │
   │   └─ 异常抛出: ValueError             │
   └──────────────────────────────────────┘

3. YOLOv8s模型架构
   ┌──────────────────────────────────────┐
   │ Backbone: CSPDarknet53               │
   │   ├─ 深度: 33层                       │
   │   ├─ 宽度: 0.5倍                      │
   │   └─ 激活函数: SiLU                   │
   ├──────────────────────────────────────┤
   │ Neck: PAN (Path Aggregation)         │
   │   ├─ 特征融合: FPN + Bottom-up        │
   │   └─ 输出层: P3/8, P4/16, P5/32       │
   ├──────────────────────────────────────┤
   │ Head: Decoupled Head                 │
   │   ├─ 分类分支: Conv + Softmax         │
   │   ├─ 回归分支: Conv + DFL             │
   │   └─ 类别数: 80 (COCO)                │
   ├──────────────────────────────────────┤
   │ 后处理: NMS                           │
   │   ├─ 置信度阈值: 0.5                  │
   │   ├─ IoU阈值: 0.65                    │
   │   └─ 最大检测数: 300                  │
   └──────────────────────────────────────┘

4. NPU推理优化
   ┌──────────────────────────────────────┐
   │ MindSpore图模式                       │
   │   ├─ 静态图编译                       │
   │   ├─ 算子融合                         │
   │   └─ 内存优化                         │
   ├──────────────────────────────────────┤
   │ 昇腾310B加速                          │
   │   ├─ AI Core: 8 TOPS INT8             │
   │   ├─ 专用算子库                       │
   │   └─ 自动混合精度 (AMP)               │
   ├──────────────────────────────────────┤
   │ 性能优化                              │
   │   ├─ 模型预热 (首次推理)              │
   │   ├─ Batch推理 (batch_size=1)        │
   │   └─ 异步推理 (可选)                  │
   └──────────────────────────────────────┘

5. 坐标系变换链路
   ┌──────────────────────────────────────┐
   │ 图像坐标系 (像素)                     │
   │   原点: 左上角 (0, 0)                 │
   │   X轴: 向右 (0-640)                   │
   │   Y轴: 向下 (0-480)                   │
   └──────────────────────────────────────┘
                  ↓ 透视变换 (dp.bin)
   ┌──────────────────────────────────────┐
   │ 校准后图像坐标                        │
   │   消除畸变                            │
   │   归一化到工作区域                    │
   └──────────────────────────────────────┘
                  ↓ 像素→物理坐标
   ┌──────────────────────────────────────┐
   │ 相机坐标系 (米)                       │
   │   公式: a = (u-320)/4000              │
   │         b = (480-v)/3000*0.8+0.19     │
   └──────────────────────────────────────┘
                  ↓ 偏移补偿
   ┌──────────────────────────────────────┐
   │ 机械臂基坐标系                        │
   │   原点: 机械臂底座                    │
   │   X轴: 向前                           │
   │   Y轴: 向左                           │
   │   Z轴: 向上                           │
   └──────────────────────────────────────┘

6. ROS2通信机制
   ┌──────────────────────────────────────┐
   │ Service定义: Kinemarics.srv          │
   │ Request:                             │
   │   - tar_x, tar_y, tar_z (目标位姿)   │
   │   - kin_name: "ik" (逆运动学)        │
   │ Response:                            │
   │   - joint1~6 (关节角度)              │
   │   - x, y, z (验证位姿)               │
   └──────────────────────────────────────┘
                  ↓
   ┌──────────────────────────────────────┐
   │ Client调用流程                        │
   │   1. wait_for_service()              │
   │   2. call_async(request)             │
   │   3. spin_until_future_complete()    │
   │   4. future.result()                 │
   └──────────────────────────────────────┘

7. 机械臂DH参数 (DOFBOT)
   ┌─────┬───────┬───────┬───────┬───────┐
   │ i   │ a(mm) │ α(°)  │ d(mm) │ θ(°)  │
   ├─────┼───────┼───────┼───────┼───────┤
   │ 1   │ 0     │ 90    │ 61    │ θ1    │
   │ 2   │ 85    │ 0     │ 0     │ θ2    │
   │ 3   │ 80    │ 0     │ 0     │ θ3    │
   │ 4   │ 0     │ 90    │ 0     │ θ4    │
   │ 5   │ 0     │ -90   │ 74.3  │ θ5    │
   │ 6   │ 0     │ 0     │ 43.5  │ θ6    │
   └─────┴───────┴───────┴───────┴───────┘
   工作空间: 半径 ~300mm, 高度 ~250mm


================================================================================
【数据流示例】
================================================================================

完整执行链路(以"帮我拿水杯"为例):

1. 语音输入
   音频流 → [0x1A3F, 0x2B4C, ...] (PCM数据)
             ↓
   科大讯飞 → "帮我拿水杯"

2. LLM解析
   Text: "帮我拿水杯"
             ↓
   Doubao → ["水杯"]

3. 视觉检测
   Image: 640×480 BGR
             ↓ resize+normalize
   Tensor: [1, 3, 640, 640]
             ↓ NPU推理 (30ms)
   Output: [1, 25200, 85]
             ↓ NMS
   Detections: [
     {class_name: "cup", conf: 0.87, bbox: [280, 180, 360, 260], center: (320, 220)}
   ]

4. 目标匹配
   voice_target: "水杯"
             ↓ 映射
   english_target: "cup"
             ↓ 查找
   matched: {class_name: "cup", center: (320, 220)}

5. 坐标映射
   pixel: (320, 220)
             ↓ 公式转换
   camera: (0.0000, 0.2453)
             ↓ 偏移补偿
   robot: (0.0100, 0.2613)

6. 逆运动学
   target_pose: (0.0100, 0.2613, 0.0)
             ↓ IK求解
   joints: [90.5, 85.2, 10.3, 45.6, 90.0, 30.0]

7. 机械执行
   joints → UART指令 → 舵机驱动
             ↓
   物理动作: 移动→抓取→返回


================================================================================
【性能分析】
================================================================================

延迟分解:
  ├─ 语音识别:      0.8s   (WebSocket流式传输)
  ├─ LLM解析:       1.5s   (API调用+推理)
  ├─ 图像采集:      0.03s  (USB摄像头)
  ├─ NPU推理:       0.03s  (YOLOv8s)
  ├─ 目标匹配:      0.001s (Python逻辑)
  ├─ 坐标映射:      0.001s (数学运算)
  ├─ 逆运动学:      0.2s   (ROS2服务)
  └─ 机械执行:      3-5s   (物理运动)
  ────────────────────────────────────
  总计:             6-8s

瓶颈识别:
  1. LLM API调用 (1.5s) - 可优化为本地模型
  2. 机械臂物理运动 (3-5s) - 硬件限制

优化方向:
  1. 部署本地LLM(如Qwen-7B) → 延迟降至0.3s
  2. 预测性预位置 → 减少运动时间
  3. 异步并行处理 → 语音识别同时启动摄像头

================================================================================
